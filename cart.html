<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
// add this before event code to all pages where PII data postback is expected and appropriate 
ttq.identify({
	"email": "<hashed_email_address>", // string. The email of the customer if available. It must be hashed with SHA-256 on the client side.
	"phone_number": "<hashed_phone_number>", // string. The phone number of the customer if available. It must be hashed with SHA-256 on the client side.
	"external_id": "<hashed_external_id>" // string. Any unique identifier, such as loyalty membership IDs, user IDs, and external cookie IDs.It must be hashed with SHA-256 on the client side.
});

ttq.track('ViewContent', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('AddToWishlist', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('Search', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>", // string. The 4217 currency code. Example: "USD".
	"search_string": "<search_keywords>" // string. The word or phrase used to search. Example: "SAVE10COUPON".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('AddPaymentInfo', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('AddToCart', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('InitiateCheckout', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('PlaceAnOrder', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('CompleteRegistration', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});

ttq.track('Purchase', {
	"contents": [
		{
			"content_id": "<content_identifier>", // string. ID of the product. Example: "1077218".
			"content_type": "<content_type>", // string. Either product or product_group.
			"content_name": "<content_name>" // string. The name of the page or product. Example: "shirt".
		}
	],
	"value": "<content_value>", // number. Value of the order or items sold. Example: 100.
	"currency": "<content_currency>" // string. The 4217 currency code. Example: "USD".
}, {
	"event_id": "<event_id>" // string. A hashed ID that can identify a unique event. Example: "1616318632825_357".
});
    <!-- TikTok Pixel Code Start -->
<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};


  ttq.load('D4H50F3C77UA1JCPR9L0');
  ttq.page();
}(window, document, 'ttq');
</script>
<!-- TikTok Pixel Code End -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø³Ù„Ø© | Velin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        :root { --primary: #FF5000; --text: #333; --bg: #eff0f5; --white: #fff; --danger: #ff4d4f; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: var(--text); }
        
        /* Header */
        .header { background: var(--white); padding: 15px; display: flex; align-items: center; gap: 10px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        
        /* Cart Items */
        .cart-list { padding: 10px; }
        .cart-item { background: var(--white); border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .item-details h3 { font-size: 0.95rem; margin: 0 0 5px 0; color: #222; }
        .item-price { color: var(--primary); font-weight: 700; font-size: 1rem; }
        .remove-btn { color: #999; background: none; border: none; padding: 5px; cursor: pointer; font-size: 1.1rem; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 50px 20px; color: #999; display: none; }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; color: #ddd; }
        
        /* Checkout Form Section */
        .checkout-section { background: var(--white); padding: 20px; margin: 10px; border-radius: 10px; }
        .section-title { font-weight: 700; margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9; font-family: inherit; box-sizing: border-box; transition: 0.3s; }
        .form-input:focus { border-color: var(--primary); outline: none; background: #fff; }
        
        /* Footer Summary */
        .cart-footer { position: fixed; bottom: 0; width: 100%; background: var(--white); padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 200; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; }
        .price-row { display: flex; justify-content: space-between; font-size: 0.9rem; color: #666; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 800; color: var(--primary); margin-top: 5px; padding-top: 10px; border-top: 1px dashed #ddd; }
        
        .checkout-btn { width: 100%; background: linear-gradient(to right, #FF5000, #ff8e00); color: white; border: none; padding: 15px; border-radius: 30px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 5px; }
        .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Bottom Nav */
        .bottom-nav { display: none; } /* Ù†Ø®ÙÙŠ Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ù‡Ù†Ø§ Ù„Ø£Ù†Ù†Ø§ Ù†Ø±ÙŠØ¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹ */
    </style>
</head>
<body>

    <div class="header">
        <i class="fa-solid fa-arrow-right" style="cursor:pointer;" onclick="history.back()"></i>
        <span>Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</span>
    </div>

    <div id="empty-cart" class="empty-state">
        <i class="fa-solid fa-cart-arrow-down"></i>
        <h3>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</h3>
        <p>ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ£Ø¶Ù Ù…Ø§ ÙŠØ¹Ø¬Ø¨Ùƒ</p>
        <a href="index.html" style="color:var(--primary); text-decoration:none; font-weight:700;">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
    </div>

    <div id="cart-items" class="cart-list">
        </div>

    <div class="checkout-section" id="shipping-form" style="display: none;">
        <div class="section-title"><i class="fa-solid fa-truck-fast" style="color:var(--primary);"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        <input type="text" id="c_name" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" required>
        <input type="tel" id="c_phone" class="form-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ Ø§Ù„Ù…ÙØªØ§Ø­)" required>
        <textarea id="c_address" class="form-input" rows="2" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©)" required></textarea>
    </div>

    <div class="cart-footer" id="cart-footer" style="display: none;">
        <div class="price-row">
            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
            <span id="sub-total">0 Ø¯.Ø¹</span>
        </div>
        <div class="price-row">
            <span>Ø§Ù„ØªÙˆØµÙŠÙ„:</span>
            <span>3,000 Ø¯.Ø¹</span>
        </div>
        <div class="total-row">
            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
            <span id="final-total">0 Ø¯.Ø¹</span>
        </div>
        <button class="checkout-btn" id="confirm-btn" onclick="processOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://pajxormplmloivyankji.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhanhvcm1wbG1sb2l2eWFua2ppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0ODQ3OTksImV4cCI6MjA3NjA2MDc5OX0.eEPB_Gt5HywU9oGNXLpSNc4IA7CTTL7CX-EMKDE3yec';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const DELIVERY_FEE = 3000;

        let cart = JSON.parse(localStorage.getItem('velin_cart')) || [];

        function renderCart() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            const empty = document.getElementById('empty-cart');
            const form = document.getElementById('shipping-form');

            container.innerHTML = '';

            if (cart.length === 0) {
                empty.style.display = 'block';
                footer.style.display = 'none';
                form.style.display = 'none';
                return;
            }

            empty.style.display = 'none';
            footer.style.display = 'flex';
            form.style.display = 'block';

            let subTotal = 0;

            cart.forEach(item => {
                subTotal += item.price;
                container.innerHTML += `
                    <div class="cart-item">
                        <div class="item-details">
                            <h3>${item.name}</h3>
                            <div class="item-price">${item.price.toLocaleString()} Ø¯.Ø¹</div>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${item.temp_id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
            });

            document.getElementById('sub-total').innerText = subTotal.toLocaleString() + ' Ø¯.Ø¹';
            document.getElementById('final-total').innerText = (subTotal + DELIVERY_FEE).toLocaleString() + ' Ø¯.Ø¹';
        }

        function removeItem(tempId) {
            cart = cart.filter(item => item.temp_id !== tempId);
            localStorage.setItem('velin_cart', JSON.stringify(cart));
            renderCart();
        }

        // ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        async function processOrder() {
            const name = document.getElementById('c_name').value;
            const phone = document.getElementById('c_phone').value;
            const address = document.getElementById('c_address').value;

            if (!name || !phone || !address) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„');
                return;
            }

            const btn = document.getElementById('confirm-btn');
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";

            try {
                // 1. ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª)
                const cartCounts = {};
                cart.forEach(item => {
                    cartCounts[item.product_id] = (cartCounts[item.product_id] || 0) + 1;
                });

                const totalPrice = cart.reduce((sum, item) => sum + item.price, 0) + DELIVERY_FEE;

                // 2. Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø¬Ø¯ÙˆÙ„ orders
                const orderData = {
                    customer_name: name,
                    customer_phone: phone,
                    customer_address: address,
                    price: totalPrice,
                    cart_items: cartCounts,
                    status: 'new'
                };

                const { error: orderError } = await supabase.from('orders').insert([orderData]);
                if (orderError) throw orderError;

                // 3. Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ products)
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù…Ø§ Ø£Ù† Supabase Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ÙØ±ÙˆÙ†Øª Ø¥Ù†Ø¯ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø±ÙŠØ©
                for (const [productId, quantity] of Object.entries(cartCounts)) {
                    // Ø£. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
                    const { data: product, error: fetchError } = await supabase
                        .from('products')
                        .select('stock')
                        .eq('id', productId)
                        .single();
                    
                    if (fetchError) {
                        console.error(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ù†ØªØ¬ ${productId}`, fetchError);
                        continue; 
                    }

                    // Ø¨. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªØ­Ø¯ÙŠØ«Ù‡
                    if (product) {
                        const newStock = Math.max(0, product.stock - quantity);
                        await supabase
                            .from('products')
                            .update({ stock: newStock })
                            .eq('id', productId);
                    }
                }

                // 4. Ø§Ù„Ù†Ø¬Ø§Ø­
                alert('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
                localStorage.removeItem('velin_cart');
                window.location.href = 'index.html'; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

            } catch (err) {
                console.error(err);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨: ' + err.message);
                btn.disabled = false;
                btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…)";
            }
        }

        renderCart();
    </script>
</body>

</html>

